---
output:
  govdown::govdown_document:
    keep_md: false
    logo_text: "DfE"
    font: "sans-serif"
    title: "Explore education statistics"
    phase: beta
    feedback_url: "https://github.com/lauraselby/data-screener/issues"
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

file_data <- paste("data_metadata/",your_data_file,'.csv',sep = "")
meta_data <- paste("data_metadata/",your_data_file,'.meta.csv',sep = "")
dataset <- read_csv(file_data,trim_ws = FALSE)
metadata <- read_csv(meta_data,trim_ws = FALSE)
metadata_utf16 <- read.csv(meta_data,stringsAsFactors = FALSE,encoding = "UTF-16")

source("setup_functions/function_setup.R")

  indicators_u <- filter(metadata_utf16,col_type == "Indicator")
  real_indicators <- indicators_u$indicator_unit[!indicators_u$indicator_unit == ""]
  all <- length(unique(real_indicators))
  acceptable_indicator_units <- c('Â£',"%")
  acceptable <- length(intersect(acceptable_indicator_units,real_indicators))
  invalid_indicator_units <- setdiff(unique(real_indicators),acceptable_indicator_units)
```

## Underlying data testing {caption="`r Sys.time()`"} 
File tested: `r your_data_file` `r if(total_percent == 100){knitr::include_graphics("images/checked.png")}else{knitr::include_graphics("images/cancel.png")}`

`r total_percent` of tests passed overall.

::: {.tabset}

## Data file validation

`r paste(your_data_file,".csv",sep="")` `r if(data_percent == 100){knitr::include_graphics("images/checked.png")}else{knitr::include_graphics("images/cancel.png")}`
<br><br>
`r data_percent` of tests passed on the data file. 


:::{.accordion}

## General validation
 **Checking that the compulsory columns are present**  `r if(data_comp_col_result == "TRUE"){knitr::include_graphics("images/checked.png")}else{if(data_comp_col_result == "NA"){knitr::include_graphics("images/not-applicable.png")}else{knitr::include_graphics("images/cancel.png")}`
```{r data_comp_col, echo=FALSE,comment=NA}
data_comp_col(dataset)
```

 **Checking for commas in the data file** `r if(comma_result == "TRUE"){knitr::include_graphics("images/checked.png")}else{knitr::include_graphics("images/cancel.png")}`
```{r comma,echo=FALSE,comment=NA}
comma(dataset)
```

 **Checking for spaces in the data file variable names** `r if(data_spaces_result == "TRUE"){knitr::include_graphics("images/checked.png")}else{knitr::include_graphics("images/cancel.png")}`
```{r data_spaces,echo=FALSE,comment=NA}
data_spaces(dataset)
```

## Time validation `r knitr::include_graphics("images/checked.png")`
 **Checking that the time_period is either 4 or 6 digits, and if 6 digits that they show  consecutive years**
```{r time_period, echo=FALSE,warning=FALSE,comment=NA}
time_period(dataset)
```

 **Checking if the time_identifier values are valid**
```{r time_identifier,comment=NA,echo=FALSE}
time_identifier(dataset)
```

 **Checking that all identifiers are compatible**
```{r time_identifier_mix, echo=FALSE,comment=NA}
time_identifier_mix(dataset)
```


## Geography validation
 **Checking that the geographic levels are valid**
```{r level_validity,echo=FALSE,comment=NA}
level_validity(dataset)
```

 **Checking that the correct geography columns are present for the levels in the data file**
```{r geography_levels_present,echo=FALSE,comment=NA}
geography_level_present(dataset)
```

 **Checking that the correct geography columns are completed for each of the levels in the data file**
```{r geography_level_completed,echo=FALSE,warning=FALSE,comment=NA}
geography_level_completed(dataset)
```

## Filter validation

 **Checking that filters include in the metadata have at least two levels**
```{r filter_levels,echo=FALSE,comment=NA}
filter_levels(dataset,metadata)
```

 **Checking that each filter has a 'Total'**
```{r total,echo=FALSE,comment=NA}
total(dataset,metadata)
```
 
 **Checking that no observational unit has a 'Total'**
```{r observational_total,echo=FALSE,comment=NA}
observational_total(dataset)
```
:::

## Metadata validation

`r paste(your_data_file,".meta.csv",sep="")` `r if(meta_percent == 100){knitr::include_graphics("images/checked.png")}else{knitr::include_graphics("images/cancel.png")}` 
<br><br>
`r meta_percent` of tests passed on the metadata file.


::: {.accordion}
## General validation

 **Checking that the compulsory columns are present**
```{r meta_comp_col,echo=FALSE,comment=NA}
meta_comp_col(metadata)
```

 **Cross checking the columns in the metadata are in the data file**
```{r column_crosscheck,echo=FALSE,warning=FALSE,comment=NA}
column_crosscheck(dataset,metadata)
```

 **Check to catch any variables from the data file that are not in the metadata**
```{r meta_crosscheck,echo=FALSE,warning=FALSE,comment=NA}
meta_crosscheck(dataset,metadata)
```

 **Checking for commas**
```{r meta_comma,echo=FALSE,comment=NA}
meta_comma(metadata)
```

## Variable and label validation

 **Checking if col_name is completed for every row**
```{r col_name_completed,echo=FALSE,comment=NA}
col_name_completed(metadata)
```

 **Checking for duplicate col_names**
```{r meta_duplicate,echo=FALSE,comment=NA}
meta_duplicate(metadata)
```

 **Checking for spaces in the values in the col_name column**
```{r col_name_spaces,echo=FALSE,comment=NA}
col_name_spaces(metadata)
```

 **Checking if any observational units have been erroneously included in the metadata**
```{r comp_col_meta,echo=FALSE,warning=FALSE,comment=NA}
comp_col_meta(metadata)
```

 **Checking that col_type values are valid**
```{r col_type,echo=FALSE,warning=FALSE,comment=NA}
col_type(metadata)
```

 **Checking that every row has a label completed**
```{r label,echo=FALSE,comment=NA}
label(metadata)
```
 
 **Checking that there are no duplicate labels**
```{r duplicate_label,echo=FALSE,comment=NA}
duplicate_label(metadata)
```

## Filter and indicator validation

 **Checking that no filters have an indicator group**
```{r indicator_group,echo=FALSE,comment=NA}
indicator_group(metadata)
```

 **Checking that all indicator units are valid**
```{r indicator_unit_validation,warning=FALSE,echo=FALSE,comment=NA}
indicator_unit_validation(metadata_utf16)
```

 **Checking that no filters have an indicator unit**
```{r indicator_unit,echo=FALSE,comment=NA}
indicator_unit(metadata)
```

 **Checking that no indicators have a filter hint**
```{r filter_hint,echo=FALSE,comment=NA}
filter_hint(metadata)
```

 **Checking that no indicators have a filter group**
```{r filter_group,echo=FALSE,comment=NA}
filter_group(metadata)
```

 **Checking that the number of rows in the metadata is less than the number of columns in the data file**
```{r row,echo=FALSE,comment=NA}
row(dataset,metadata)
```

 **Checking filter groups are variables in the data file**
```{r filter_group_match,echo=FALSE,comment=NA}
filter_group_match(dataset,metadata)
```

 **Checking that filter and filter group have been entered into the correct columns**
```{r filter_group_levels,echo=FALSE,comment=NA}
filter_group_levels(dataset,metadata)
```


:::
:::

:::{.details summary="Further information"}
:::{.warning}
 For further information, or if you have any questions about this report contact cameron.race@education.gov.uk.
:::
:::

```{r results_calculator,include=FALSE}
screening_tests(dataset,metadata,metadata_utf16)

data_filter_results_function()
data_general_results_function()
data_geography_results_function()
data_time_results_function()
meta_filter_indicator_results_function()
meta_general_results_function()
meta_variable_label_results_function()

data_results <- c(data_filter_results,data_general_results,data_geography_results,data_time_results)
meta_results <- c(meta_filter_indicator_results,meta_general_results,meta_variable_label_results)
all_results <- c(data_results,meta_results)

ignore <- sum(is.na(all_results))
pass <- length(which(all_results==TRUE))
fail <- length(which(all_results==FALSE))

data_ignore <- sum(is.na(data_results))
data_pass <- length(which(data_results==TRUE))
data_fail <- length(which(data_results==FALSE))
  
meta_ignore <- sum(is.na(meta_results))
meta_pass <- length(which(meta_results==TRUE))
meta_fail <- length(which(meta_results==FALSE))

data_percent <- paste(round((data_pass/(data_pass+data_fail))*100,1),"%",sep="")
meta_percent <- paste(round((meta_pass/(meta_pass+meta_fail))*100,1),"%",sep="")
total_percent <- paste(round((pass/(pass+fail))*100,1),"%",sep="")
```